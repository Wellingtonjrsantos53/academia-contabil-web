<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academia de Contabilidade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.0/math.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .razonete-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        .t-account { border-top: 2px solid #334155; position: relative; }
        .t-account::after { content: ''; position: absolute; left: 50%; top: 0; bottom: 0; width: 2px; background: #334155; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .calc-container { background: #1e293b; color: white; border-radius: 24px; padding: 20px; width: 100%; max-width: 340px; }
        .calc-display { background: #0f172a; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #334155; text-align: right; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .calc-btn { height: 50px; border-radius: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; border: none; color: white; }
        .calc-btn:hover { filter: brightness(1.2); transform: translateY(-1px); }
        .btn-num { background: #334155; }
        .btn-op { background: #6366f1; }
        .btn-clear { background: #ef4444; }
        .btn-equal { background: #10b981; grid-column: span 2; }

        #welcome-modal, #payment-modal { transition: opacity 0.3s ease-out; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2 cursor-pointer" onclick="showView('home')">
                    <div class="bg-indigo-600 p-2 rounded-lg text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                    </div>
                    <span class="text-xl font-bold text-slate-800 tracking-tight">Academia Cont√°bil</span>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="toggleAdminPanel()" class="flex items-center gap-2 bg-slate-800 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-slate-700 transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Painel do Professor
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 md:p-8">

        <div id="view-home" class="py-10 space-y-12">
            <div class="text-center space-y-4 max-w-3xl mx-auto">
                <h1 class="text-4xl md:text-5xl font-black text-slate-900 leading-tight">Escolha seu <span class="text-indigo-600">M√≥dulo de Estudo.</span></h1>
                <p class="text-slate-500 text-lg">Pr√°tica laboratorial ou prepara√ß√£o te√≥rica para o Exame de Sufici√™ncia.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div onclick="showView('simulador')" class="cursor-pointer bg-white p-8 rounded-3xl shadow-sm border border-slate-200 hover:shadow-xl hover:border-indigo-300 transition-all group">
                    <div class="bg-indigo-50 w-16 h-16 rounded-2xl flex items-center justify-center mb-6 group-hover:bg-indigo-600 group-hover:text-white transition-all text-indigo-600">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-800">Simulador de Lan√ßamentos</h3>
                    <p class="text-slate-500 mt-2">Pr√°tica de partidas dobradas e demonstra√ß√µes cont√°beis.</p>
                </div>
                <div onclick="showView('cfc')" class="cursor-pointer bg-white p-8 rounded-3xl shadow-sm border border-slate-200 hover:shadow-xl hover:border-emerald-300 transition-all group">
                    <div class="bg-emerald-50 w-16 h-16 rounded-2xl flex items-center justify-center mb-6 group-hover:bg-emerald-600 group-hover:text-white transition-all text-emerald-600">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-800">Preparat√≥rio CFC</h3>
                    <p class="text-slate-500 mt-2">Quest√µes te√≥ricas do Exame de Sufici√™ncia.</p>
                </div>
            </div>
        </div>

        <div id="view-simulador" class="hidden space-y-8">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-slate-800">Laborat√≥rio de Lan√ßamentos</h2>
                <button onclick="resetSimulador()" class="text-xs font-bold text-rose-600 bg-rose-50 px-3 py-1 rounded-full">Zerar Progresso</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-8 space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 relative overflow-hidden">
                        <div id="success-overlay" class="absolute inset-0 bg-emerald-600/95 flex flex-col items-center justify-center text-white hidden z-30">
                            <span class="text-4xl mb-2">‚úîÔ∏è</span>
                            <h4 class="text-xl font-bold">Correto!</h4>
                        </div>
                        <div class="flex justify-between items-center mb-4">
                            <span id="question-number-tag" class="bg-slate-800 text-white text-[10px] px-3 py-1 rounded-full font-bold uppercase tracking-widest">Quest√£o 1</span>
                            <div id="difficulty-badge" class="text-[10px] font-bold text-indigo-600 px-3 py-1 bg-indigo-50 rounded-full border border-indigo-100">---</div>
                        </div>
                        <h2 id="current-question-title" class="text-xl font-bold text-slate-800 mb-2">---</h2>
                        <p id="current-question-desc" class="text-slate-600 text-sm italic leading-relaxed"></p>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <div id="entries-container" class="space-y-3"></div>
                        <div class="mt-6 flex justify-between gap-4">
                            <div class="flex-1 bg-slate-50 p-3 rounded-xl text-center"><span class="text-[10px] text-slate-400 font-bold uppercase">D√©bito</span><div id="total-debit" class="text-lg font-black">R$ 0,00</div></div>
                            <div class="flex-1 bg-slate-50 p-3 rounded-xl text-center"><span class="text-[10px] text-slate-400 font-bold uppercase">Cr√©dito</span><div id="total-credit" class="text-lg font-black">R$ 0,00</div></div>
                        </div>
                        <div class="grid grid-cols-1 gap-2 mt-4">
                            <button onclick="addEntryRow()" class="bg-slate-100 text-slate-600 py-2 rounded-xl font-bold hover:bg-slate-200 transition-all text-xs border border-slate-200">
                                + Adicionar D√©bito ou Cr√©dito
                            </button>
                            <button onclick="validateEntry()" class="bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg transition-all">
                                Validar Lan√ßamento
                            </button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-700 text-xs uppercase mb-4 tracking-widest">Razonetes</h3>
                        <div id="razonetes-container" class="razonete-grid"></div>
                    </div>
                </div>

                <div class="lg:col-span-4 space-y-6">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="p-4 bg-slate-800 text-white text-xs font-bold uppercase">Balan√ßo Patrimonial</div>
                        <div class="p-5 space-y-4 text-[11px]">
                            <section>
                                <div class="flex justify-between border-b border-indigo-100 font-bold text-indigo-700 mb-2"><span>ATIVO</span><span id="total-ativo">R$ 0,00</span></div>
                                <div id="list-ativo" class="space-y-1 text-slate-600"></div>
                            </section>
                            <section>
                                <div class="flex justify-between border-b border-rose-100 font-bold text-rose-700 mb-2"><span>PASSIVO</span><span id="total-passivo">R$ 0,00</span></div>
                                <div id="list-passivo" class="space-y-1 text-slate-600"></div>
                            </section>
                            <section>
                                <div class="flex justify-between border-b border-emerald-100 font-bold text-emerald-700 mb-2"><span>PL</span><span id="total-pl">R$ 0,00</span></div>
                                <div id="list-pl" class="space-y-1 text-slate-600"></div>
                            </section>

                            <button onclick="toggleCalculator()" class="w-full mt-4 bg-slate-100 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-200 transition-all flex items-center justify-center gap-2 border border-slate-200">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                                Calculadora Auxiliar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-cfc" class="hidden space-y-8">
            <div class="flex items-center gap-4">
                <button onclick="showView('home')" class="text-slate-400 hover:text-indigo-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                <h2 class="text-2xl font-bold text-slate-800">Preparat√≥rio Exame CFC</h2>
            </div>
            <div class="max-w-3xl mx-auto" id="cfc-app-container"></div>
        </div>

        <div id="payment-modal" class="hidden fixed inset-0 z-[300] bg-slate-900/95 backdrop-blur-xl flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden border border-indigo-100">
                <div class="bg-indigo-600 p-6 text-center text-white">
                    <h2 class="text-2xl font-black">Recarga de Acesso</h2>
                    <p class="text-indigo-100 text-sm mt-1">Obtenha 30 dias de acesso ilimitado.</p>
                </div>
                <div class="p-8 text-center space-y-6">
                    <div id="qr-container" class="flex flex-col items-center min-h-[250px] justify-center">
                        <div id="qr-placeholder" class="w-48 h-48 bg-slate-100 animate-pulse rounded-lg flex items-center justify-center text-slate-400 text-[10px] text-center p-6 uppercase font-bold">
                            Gerando QR Code PIX em Produ√ß√£o...
                        </div>
                    </div>

                    <div class="space-y-3">
                        <button id="btn-update-qr" onclick="gerarPagamentoMP()" class="text-[10px] font-bold text-indigo-600 uppercase tracking-widest hover:underline">Atualizar QR Code</button>
                        <button onclick="confirmarRecarga()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-slate-800 transition-all shadow-lg active:scale-95">
                            J√° realizei a recarga
                        </button>
                        <p class="text-[10px] text-slate-400">O sistema valida seu pagamento instantaneamente ap√≥s o PIX.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="calc-modal" class="hidden fixed inset-0 z-[120] bg-slate-900/70 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="calc-container shadow-2xl relative">
                <button onclick="toggleCalculator()" class="absolute -top-10 right-0 text-white hover:text-rose-400 font-bold flex items-center gap-1">
                    <span>FECHAR</span> <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <div class="text-[10px] font-bold text-slate-400 mb-2 tracking-widest text-center">SOLVER ENGINE v2.0</div>
                <div class="calc-display">
                    <input type="text" id="calcInput" class="w-full bg-transparent border-none text-right text-slate-400 outline-none text-sm font-mono" placeholder="Express√£o...">
                    <div id="calcResult" class="text-2xl font-bold mt-1 overflow-hidden">0</div>
                </div>
                <div class="calc-grid">
                    <button class="calc-btn btn-clear" onclick="calcClear()">AC</button>
                    <button class="calc-btn btn-op" onclick="calcInsert('^')">x ∏</button>
                    <button class="calc-btn btn-op" onclick="calcInsert('(')">(</button>
                    <button class="calc-btn btn-op" onclick="calcInsert(')')">)</button>
                    <button class="calc-btn btn-num" onclick="calcInsert('7')">7</button>
                    <button class="calc-btn btn-num" onclick="calcInsert('8')">8</button>
                    <button class="calc-btn btn-num" onclick="calcInsert('9')">9</button>
                    <button class="calc-btn btn-op" onclick="calcInsert('/')">√∑</button>
                    <button class="calc-btn btn-num" onclick="calcInsert('4')">4</button>
                    <button class="calc-btn btn-num" onclick="calcInsert('5')">5</button>
                    <button class="calc-btn btn-num" onclick="calcInsert('6')">6</button>
                    <button class="calc-btn btn-op" onclick="calcInsert('*')">√ó</button>
                    <button class="calc-btn btn-num" onclick="calcInsert('1')">1</button>
                    <button class="calc-btn btn-num" onclick="calcInsert('2')">2</button>
                    <button class="calc-btn btn-num" onclick="calcInsert('3')">3</button>
                    <button class="calc-btn btn-op" onclick="calcInsert('-')">-</button>
                    <button class="calc-btn btn-num" onclick="calcInsert('0')">0</button>
                    <button class="calc-btn btn-num" onclick="calcInsert('.')">.</button>
                    <button class="calc-btn btn-op" onclick="calcInsert('+')">+</button>
                    <button class="calc-btn btn-num bg-slate-600" onclick="calcDelete()">‚å´</button>
                    <button class="calc-btn btn-equal" onclick="calcSolve()">RESOLVER</button>
                </div>
            </div>
        </div>

        <div id="welcome-modal" class="fixed inset-0 z-[200] bg-slate-900/80 backdrop-blur-md flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden">
                <div class="bg-indigo-600 p-8 text-center text-white">
                    <div class="bg-white/20 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 backdrop-blur-sm">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-7.714 2.143L11 21l-2.286-6.857L1 12l7.714-2.143L11 3z"></path></svg>
                    </div>
                    <h2 class="text-3xl font-black italic">Bem-vindo(a)!</h2>
                    <p class="text-indigo-100 mt-2">Sua jornada rumo √† excel√™ncia cont√°bil come√ßa aqui.</p>
                </div>
                <div class="p-8 space-y-6">
                    <div class="space-y-4">
                        <div class="flex gap-4">
                            <div class="bg-emerald-100 text-emerald-600 p-2 rounded-lg h-10 w-10 flex items-center justify-center shrink-0">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-800 text-sm">Pr√°tica Laboratorial</h4>
                                <p class="text-[12px] text-slate-500">Treine lan√ßamentos cont√°beis com razonetes e balan√ßo em tempo real.</p>
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <div class="bg-amber-100 text-amber-600 p-2 rounded-lg h-10 w-10 flex items-center justify-center shrink-0">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-800 text-sm">Preparat√≥rio CFC</h4>
                                <p class="text-[12px] text-slate-500">Resolva quest√µes te√≥ricas focadas no Exame de Sufici√™ncia.</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="closeWelcomeModal()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-slate-800 transition-all shadow-lg">
                        Come√ßar a Estudar
                    </button>
                </div>
            </div>
        </div>

        <div id="admin-login-modal" class="hidden fixed inset-0 z-[200] bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden transform transition-all">
                <div class="bg-slate-800 p-6 text-center text-white">
                    <div class="bg-indigo-500 w-12 h-12 rounded-2xl flex items-center justify-center mx-auto mb-3 shadow-lg shadow-indigo-500/20">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v14a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold">√Årea Restrita</h2>
                    <p class="text-slate-400 text-xs mt-1">Acesso exclusivo para docentes</p>
                </div>

                <div class="p-8 space-y-5">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1 tracking-wider">Identifica√ß√£o</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                </span>
                                <input type="text" id="admin-user" placeholder="Usu√°rio" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all text-sm">
                            </div>
                        </div>

                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1 tracking-wider">Senha de Acesso</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v14a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                                </span>
                                <input type="password" id="admin-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all text-sm">
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3 pt-2">
                        <button onclick="handleAdminLogin()" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold hover:bg-indigo-700 transition-all shadow-md active:scale-[0.98]">
                            Entrar no Painel
                        </button>
                        <button onclick="closeAdminLogin()" class="w-full text-slate-400 text-xs font-bold py-2 hover:text-slate-600 transition-colors">
                            Voltar para o In√≠cio
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-panel" class="hidden fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-6xl max-h-[90vh] rounded-3xl shadow-2xl overflow-hidden flex flex-col">
                <div class="p-6 bg-slate-800 text-white flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold">Portal do Professor</h2>
                        <p class="text-slate-400 text-xs">Gest√£o de Conte√∫do e Plano de Contas</p>
                    </div>
                    <button onclick="toggleAdminPanel()" class="bg-slate-700 p-2 rounded-lg hover:bg-slate-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="flex-1 flex overflow-hidden">
                    <div class="w-64 border-r border-slate-100 bg-slate-50 p-4 space-y-2">
                        <button onclick="showAdminTab('accounts')" class="admin-tab-btn w-full text-left px-4 py-3 rounded-xl text-sm font-bold flex items-center gap-2 bg-indigo-600 text-white">üìÇ Plano de Contas</button>
                        <button onclick="showAdminTab('sim-questions')" class="admin-tab-btn w-full text-left px-4 py-3 rounded-xl text-sm font-bold flex items-center gap-2 text-slate-600 hover:bg-slate-200">üèóÔ∏è Desafios Lan√ßamento</button>
                        <button onclick="showAdminTab('cfc-questions')" class="admin-tab-btn w-full text-left px-4 py-3 rounded-xl text-sm font-bold flex items-center gap-2 text-slate-600 hover:bg-slate-200">üìú Quest√µes CFC</button>
                    </div>
                    <div class="flex-1 p-8 overflow-y-auto custom-scrollbar">
                        <div id="admin-tab-accounts" class="admin-content-section space-y-6">
                            <div class="bg-white border rounded-2xl p-6 shadow-sm">
                                <h3 class="font-bold text-slate-800 mb-4">Nova Conta Patrimonial</h3>
                                <div class="flex gap-4">
                                    <input type="text" id="new-acc-name" placeholder="Ex: Estoques" class="flex-1 p-3 border rounded-xl text-sm outline-none">
                                    <select id="new-acc-group" class="p-3 border rounded-xl text-sm outline-none">
                                        <option value="Ativo">Ativo</option><option value="Passivo">Passivo</option><option value="PL">PL</option><option value="Receita">Receita</option><option value="Despesa">Despesa</option>
                                    </select>
                                    <button onclick="addNewAccount()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold">Adicionar</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3" id="admin-acc-list"></div>
                        </div>
                        <div id="admin-tab-sim-questions" class="admin-content-section hidden space-y-6">
                            <div class="bg-white border rounded-2xl p-6 shadow-sm space-y-4">
                                <h3 class="font-bold text-slate-800">Criar Novo Desafio Pr√°tico</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="text" id="sim-q-title" placeholder="T√≠tulo" class="col-span-2 p-3 border rounded-xl text-sm">
                                    <select id="sim-q-level" class="p-3 border rounded-xl text-sm">
                                        <option value="B√°sico">B√°sico</option><option value="Intermedi√°rio">Intermedi√°rio</option><option value="Avan√ßado">Avan√ßado</option>
                                    </select>
                                    <input type="text" id="sim-q-desc" placeholder="Enunciado..." class="col-span-2 p-3 border rounded-xl text-sm">
                                </div>
                                <div class="p-4 bg-slate-50 rounded-2xl border border-dashed border-slate-200">
                                    <div class="flex justify-between mb-3 items-center">
                                        <span class="text-[10px] font-bold text-slate-500 uppercase">Gabarito</span>
                                        <button onclick="addSimGabaritoRow()" class="text-indigo-600 text-xs font-bold">+ Linha de Conta</button>
                                    </div>
                                    <div id="sim-gabarito-container" class="space-y-2"></div>
                                </div>
                                <button onclick="saveSimQuestion()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold">Publicar Desafio</button>
                            </div>
                            <div id="admin-sim-list" class="space-y-2"></div>
                        </div>
                        <div id="admin-tab-cfc-questions" class="admin-content-section hidden space-y-6">
                            <div class="bg-white border rounded-2xl p-6 shadow-sm space-y-4">
                                <h3 class="font-bold text-slate-800">Nova Quest√£o Te√≥rica (CFC)</h3>
                                <textarea id="cfc-q-text" rows="3" placeholder="Texto da quest√£o..." class="w-full p-3 border rounded-xl text-sm"></textarea>
                                <textarea id="cfc-q-feedback" rows="2" placeholder="Explica√ß√£o/Feedback da resposta..." class="w-full p-3 border border-indigo-100 rounded-xl text-sm bg-indigo-50/30"></textarea>
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="text" id="cfc-q-cat" placeholder="Categoria" class="p-3 border rounded-xl text-sm">
                                    <select id="cfc-q-correct" class="p-3 border rounded-xl text-sm">
                                        <option value="0">Op√ß√£o A</option><option value="1">Op√ß√£o B</option><option value="2">Op√ß√£o C</option><option value="3">Op√ß√£o D</option>
                                    </select>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    <input type="text" class="cfc-opt-input p-3 border rounded-xl text-xs" placeholder="Op√ß√£o A">
                                    <input type="text" class="cfc-opt-input p-3 border rounded-xl text-xs" placeholder="Op√ß√£o B">
                                    <input type="text" class="cfc-opt-input p-3 border rounded-xl text-xs" placeholder="Op√ß√£o C">
                                    <input type="text" class="cfc-opt-input p-3 border rounded-xl text-xs" placeholder="Op√ß√£o D">
                                </div>
                                <button onclick="saveCfcQuestion()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold">Publicar Quest√£o CFC</button>
                            </div>
                            <div id="admin-cfc-list" class="space-y-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBmZ97n-4GlIc2LxqsOF-8BrtH3Ic3Ug3w",
          authDomain: "contabilidade-a0772.firebaseapp.com",
          projectId: "contabilidade-a0772",
          storageBucket: "contabilidade-a0772.firebasestorage.app",
          messagingSenderId: "1055238532296",
          appId: "1:1055238532296:web:51e39572bc44fb0fe889fd",
          measurementId: "G-01ES97PQ21"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'contabilidade-a0772-pro';

        let globalState = {
            view: 'home',
            accounts: {},
            simQuestions: [],
            cfcQuestions: [],
            userProgress: { razas: {}, q_idx: 0, cfc_idx: 0, cfc_score: 0 },
            currentUser: null,
            cfcTimer: null
        };

        const fmt = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        // --- L√ìGICA MERCADO PAGO PRODU√á√ÉO ATUALIZADA ---
        const MP_ACCESS_TOKEN = 'APP_USR-7500112478325134-021111-12c64fd8a13547f6e00ff7db6f9ffd73-290268833';
        let currentPaymentId = null;

        window.gerarPagamentoMP = async () => {
            const container = document.getElementById('qr-container');
            container.innerHTML = `<div class="animate-pulse flex flex-col items-center"><div class="w-32 h-32 bg-slate-100 rounded-full mb-4"></div><p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Acessando API de Produ√ß√£o...</p></div>`;

            try {
                const response = await fetch('/processar-pagamento', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'},
                    body: JSON.stringify({
                      	email: 'usuario@email.com'
		})

	});
                const data = await response.json();

                if (data.point_of_interaction) {
            const qrCode = data.point_of_interaction.transaction_data.qr_code_base64;
            document.getElementById('qr-container').innerHTML = `
                <img src="data:image/jpeg;base64,${qrCode}" class="w-48 h-48 rounded-lg shadow-md">
                <p class="text-[10px] mt-4 font-mono break-all text-slate-400 p-2 bg-slate-50 rounded">
                    ${data.point_of_interaction.transaction_data.qr_code}
                </p>
            `;
        }
    } catch (error) {
        console.error("Erro ao gerar pagamento:", error);
        alert("Erro ao conectar com o servidor de pagamento.");
    }
};

        window.copyPixCode = () => {
            const textarea = document.getElementById("pix-code");
            textarea.select();
            navigator.clipboard.writeText(textarea.value);
            alert("C√≥digo Pix copiado!");
        };

        window.confirmarRecarga = async () => {
            if (!currentPaymentId) {
                alert("Gere um QR Code primeiro.");
                return;
            }

            const btn = document.querySelector('#payment-modal button[onclick="confirmarRecarga()"]');
            const originalText = btn.innerText;
            btn.innerText = "CONSULTANDO BANCO...";
            btn.disabled = true;

            try {
                const response = await fetch(`https://api.mercadopago.com/v1/payments/${currentPaymentId}`, {
                    headers: { 'Authorization': `Bearer ${MP_ACCESS_TOKEN}` }
                });
                const data = await response.json();

                if (data.status === 'approved') {
                    const trintaDiasEmMs = 30 * 24 * 60 * 60 * 1000;
                    const novaExpiracao = new Date().getTime() + trintaDiasEmMs;
                    localStorage.setItem('app_premium_expiration', novaExpiracao.toString());

                    alert("‚úÖ Pagamento Aprovado! Seu acesso premium foi liberado.");
                    document.getElementById('payment-modal').classList.add('hidden');
                    document.body.style.overflow = 'auto';
                } else {
                    alert(`Pagamento Pendente. Status: ${data.status || 'Aguardando'}. Se j√° pagou, aguarde 10 segundos.`);
                }
            } catch (error) {
                alert("Erro ao validar. Tente novamente.");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        // --- GERENCIAMENTO DE ACESSO ---
        const startCheckpointTimer = () => {
            const expirationTimestamp = localStorage.getItem('app_premium_expiration');
            const now = new Date().getTime();

            if (expirationTimestamp && now < parseInt(expirationTimestamp)) {
                return;
            }

            setTimeout(() => {
                const currentExp = localStorage.getItem('app_premium_expiration');
                if (currentExp && new Date().getTime() < parseInt(currentExp)) return;

                const modal = document.getElementById('payment-modal');
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                window.gerarPagamentoMP();
            }, 20000);
        };

        window.closeWelcomeModal = () => {
            const modal = document.getElementById('welcome-modal');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.classList.add('hidden');
                startCheckpointTimer();
            }, 300);
        };

        // --- DEMAIS L√ìGICAS ORIGINAIS DO APP ---
        document.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('welcomeShown')) {
                document.getElementById('welcome-modal').classList.add('hidden');
                startCheckpointTimer();
            } else {
                sessionStorage.setItem('welcomeShown', 'true');
            }
        });

        window.toggleCalculator = () => {
            const modal = document.getElementById('calc-modal');
            modal.classList.toggle('hidden');
            if(!modal.classList.contains('hidden')) document.getElementById('calcInput').focus();
        };

        window.calcInsert = (char) => {
            const input = document.getElementById('calcInput');
            input.value += char;
        };

        window.calcClear = () => {
            document.getElementById('calcInput').value = '';
            document.getElementById('calcResult').innerText = '0';
        };

        window.calcDelete = () => {
            const input = document.getElementById('calcInput');
            input.value = input.value.slice(0, -1);
        };

        window.calcSolve = () => {
            try {
                const expr = document.getElementById('calcInput').value;
                if(!expr) return;
                const result = math.evaluate(expr);
                document.getElementById('calcResult').innerText = math.format(result, { precision: 10 });
            } catch (e) {
                document.getElementById('calcResult').innerText = "Erro";
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                globalState.currentUser = user;
                initListeners();
            }
        });

        async function initListeners() {
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), (snap) => {
                if (snap.exists()) {
                    globalState.accounts = snap.data().accounts;
                    renderAdminAccounts();
                    if(globalState.view === 'simulador') renderSimulador();
                } else {
                    const defaults = { "Caixa": { group: "Ativo", type: "D" }, "Capital Social": { group: "PL", type: "C" } };
                    setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), { accounts: defaults });
                }
            });

            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'content', 'sim_questions'), (snap) => {
                globalState.simQuestions = snap.exists() ? snap.data().list : [];
                renderAdminSimQuestions();
                if(globalState.view === 'simulador') renderSimulador();
            });

            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'content', 'cfc_questions'), (snap) => {
                globalState.cfcQuestions = snap.exists() ? snap.data().list : [];
                renderAdminCfcQuestions();
                if(globalState.view === 'cfc') renderCfc();
            });

            onSnapshot(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'appdata', 'state'), (snap) => {
                if (snap.exists()) {
                    globalState.userProgress = snap.data();
                    if(globalState.view === 'simulador') renderSimulador();
                    if(globalState.view === 'cfc') renderCfc();
                } else {
                    setDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'appdata', 'state'), globalState.userProgress);
                }
            });
        }

        window.showView = (view) => {
            document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
            globalState.view = view;
            if (view !== 'cfc' && globalState.cfcTimer) clearInterval(globalState.cfcTimer);
            if(view === 'simulador') renderSimulador();
            if(view === 'cfc') renderCfc();
        };

        window.toggleAdminPanel = () => {
            if (!document.getElementById('admin-panel').classList.contains('hidden')) {
                document.getElementById('admin-panel').classList.add('hidden');
                return;
            }
            document.getElementById('admin-login-modal').classList.remove('hidden');
            document.getElementById('admin-user').value = '';
            document.getElementById('admin-pass').value = '';
        };

        window.closeAdminLogin = () => {
            document.getElementById('admin-login-modal').classList.add('hidden');
        };

        window.handleAdminLogin = () => {
            const user = document.getElementById('admin-user').value;
            const pass = document.getElementById('admin-pass').value;
            if (user === "Professor" && pass === "Adm.123") {
                document.getElementById('admin-login-modal').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
            } else {
                alert("Usu√°rio ou senha incorretos.");
            }
        };

        window.showAdminTab = (tab) => {
            document.querySelectorAll('.admin-content-section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`admin-tab-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('bg-indigo-600', 'text-white'));
            const btn = Array.from(document.querySelectorAll('.admin-tab-btn')).find(b => b.innerText.toLowerCase().includes(tab.split('-')[0]));
            if(btn) btn.classList.add('bg-indigo-600', 'text-white');
        };

        function renderAdminAccounts() {
            const cont = document.getElementById('admin-acc-list');
            cont.innerHTML = Object.entries(globalState.accounts).map(([name, data]) => `
                <div class="bg-white p-4 border rounded-2xl flex justify-between items-center shadow-sm">
                    <div><p class="font-bold text-sm">${name}</p><p class="text-[10px] text-slate-400 uppercase font-bold">${data.group}</p></div>
                    <button onclick="deleteAccount('${name}')" class="text-rose-400 hover:text-rose-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                </div>
            `).join('');
        }

        window.addNewAccount = async () => {
            const name = document.getElementById('new-acc-name').value;
            const grp = document.getElementById('new-acc-group').value;
            if(!name) return;
            const updated = {...globalState.accounts};
            updated[name] = { group: grp, type: (grp === 'Ativo' || grp === 'Despesa' ? 'D' : 'C') };
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), { accounts: updated });
            document.getElementById('new-acc-name').value = '';
        };

        window.deleteAccount = async (name) => {
            if(confirm(`Remover "${name}"?`)) {
                const updated = {...globalState.accounts};
                delete updated[name];
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), { accounts: updated });
            }
        };

        function renderAdminSimQuestions() {
            const cont = document.getElementById('admin-sim-list');
            cont.innerHTML = globalState.simQuestions.map((q, idx) => `
                <div class="bg-white p-4 border rounded-2xl flex justify-between items-center shadow-sm mb-2">
                    <div class="flex-1">
                        <div class="flex items-center gap-2"><span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded font-bold uppercase">${q.level}</span><p class="font-bold text-sm">${q.title}</p></div>
                        <p class="text-[11px] text-slate-500 truncate max-w-md">${q.desc}</p>
                    </div>
                    <button onclick="deleteSimQuestion(${idx})" class="text-rose-400 hover:text-rose-600 ml-4"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                </div>
            `).join('') || '<p class="text-slate-400 text-center py-4 text-xs">Sem desafios.</p>';
        }

        function renderAdminCfcQuestions() {
            const cont = document.getElementById('admin-cfc-list');
            cont.innerHTML = globalState.cfcQuestions.map((q, idx) => `
                <div class="bg-white p-4 border rounded-2xl flex justify-between items-start shadow-sm mb-2">
                    <div class="flex-1">
                        <p class="text-[10px] font-bold text-emerald-600 uppercase">${q.category || 'Geral'}</p>
                        <p class="font-medium text-sm text-slate-700 truncate max-w-md">${q.text}</p>
                        ${q.feedback ? `<p class="text-[10px] text-indigo-500 mt-1 italic"><b>Feedback:</b> ${q.feedback}</p>` : ''}
                    </div>
                    <button onclick="deleteCfcQuestion(${idx})" class="text-rose-400 hover:text-rose-600 ml-4"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                </div>
            `).join('') || '<p class="text-slate-400 text-center py-4 text-xs">Sem quest√µes.</p>';
        }

        window.saveSimQuestion = async () => {
            const title = document.getElementById('sim-q-title').value;
            const desc = document.getElementById('sim-q-desc').value;
            const gabs = Array.from(document.querySelectorAll('#sim-gabarito-container > div')).map(row => ({
                account: row.querySelector('.ad-acc').value, type: row.querySelector('.ad-type').value, val: parseFloat(row.querySelector('.ad-val').value) || 0
            }));
            if(!title || !desc || gabs.length === 0) return alert("Preencha o desafio completo.");
            const newList = [...globalState.simQuestions, { id: Date.now(), title, desc, level: document.getElementById('sim-q-level').value, answer: gabs }];
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'content', 'sim_questions'), { list: newList });
            document.getElementById('sim-q-title').value = ''; document.getElementById('sim-q-desc').value = ''; document.getElementById('sim-gabarito-container').innerHTML = '';
            alert("Desafio Salvo!");
        };

        window.deleteSimQuestion = async (idx) => {
            if(confirm("Excluir desafio?")) {
                const newList = [...globalState.simQuestions]; newList.splice(idx, 1);
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'content', 'sim_questions'), { list: newList });
            }
        };

        window.saveCfcQuestion = async () => {
            const text = document.getElementById('cfc-q-text').value;
            const feedback = document.getElementById('cfc-q-feedback').value;
            const cat = document.getElementById('cfc-q-cat').value;
            const opts = Array.from(document.querySelectorAll('.cfc-opt-input')).map(i => i.value);
            const ans = parseInt(document.getElementById('cfc-q-correct').value);
            if(!text || opts.some(o => !o)) return alert("Preencha a quest√£o e as op√ß√µes.");
            const newList = [...globalState.cfcQuestions, { text, feedback, category: cat, options: opts, answer: ans }];
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'content', 'cfc_questions'), { list: newList });
            document.getElementById('cfc-q-text').value = ''; document.getElementById('cfc-q-feedback').value = '';
            document.querySelectorAll('.cfc-opt-input').forEach(i => i.value = '');
            alert("Quest√£o CFC salva!");
        };

        window.deleteCfcQuestion = async (idx) => {
            if(confirm("Excluir quest√£o?")) {
                const newList = [...globalState.cfcQuestions]; newList.splice(idx, 1);
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'content', 'cfc_questions'), { list: newList });
            }
        };

        window.addSimGabaritoRow = () => {
            const cont = document.getElementById('sim-gabarito-container');
            const row = document.createElement('div'); row.className = 'flex gap-2 mb-1';
            const opts = Object.keys(globalState.accounts).sort().map(a => `<option value="${a}">${a}</option>`).join('');
            row.innerHTML = `<select class="ad-type p-2 border rounded text-xs"><option value="D">D</option><option value="C">C</option></select>
                             <select class="ad-acc p-2 border rounded text-xs flex-1">${opts}</select>
                             <input type="number" class="ad-val p-2 border rounded text-xs w-24" placeholder="Val">
                             <button onclick="this.parentElement.remove()" class="text-rose-500">√ó</button>`;
            cont.appendChild(row);
        };

        window.startCfcTimer = () => {
            if (globalState.cfcTimer) clearInterval(globalState.cfcTimer);
            let timeLeft = 300;
            const display = document.getElementById('timer-display');
            globalState.cfcTimer = setInterval(async () => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                if (display) display.innerText = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                if (timeLeft <= 0) {
                    clearInterval(globalState.cfcTimer);
                    alert("Tempo esgotado!");
                    const nextIdx = (globalState.userProgress.cfc_idx || 0) + 1;
                    await updateDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'appdata', 'state'), { cfc_idx: nextIdx });
                }
                timeLeft--;
            }, 1000);
        };

        function renderCfc() {
            const container = document.getElementById('cfc-app-container');
            const idx = globalState.userProgress.cfc_idx || 0;
            const questions = globalState.cfcQuestions;
            if (!questions || questions.length === 0) {
                container.innerHTML = `<div class="text-center p-10 bg-white rounded-3xl border border-slate-200 text-slate-500">Nenhuma quest√£o dispon√≠vel.</div>`;
                return;
            }
            if (idx >= questions.length) {
                if (globalState.cfcTimer) clearInterval(globalState.cfcTimer);
                container.innerHTML = `<div class="text-center p-10 bg-white rounded-3xl border border-slate-200"><h3 class="text-2xl font-bold text-slate-800">Simulado Conclu√≠do!</h3><p class="text-slate-500 mt-2">Voc√™ completou todas as quest√µes dispon√≠veis.</p><button onclick="resetCfc()" class="mt-6 bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold">Reiniciar Progresso</button></div>`;
                return;
            }
            const q = questions[idx];
            container.innerHTML = `
                <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 space-y-6">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3"><span class="bg-emerald-100 text-emerald-700 text-[10px] px-3 py-1 rounded-full font-bold uppercase">${q.category || 'Geral'}</span><div class="flex items-center gap-2 bg-rose-50 text-rose-600 px-3 py-1 rounded-full border border-rose-100 font-mono font-bold text-xs"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span id="timer-display">05:00</span></div></div>
                        <div class="flex items-center gap-4"><button onclick="toggleCalculator()" class="flex items-center gap-1 text-indigo-600 hover:text-indigo-800 font-bold text-[10px] uppercase tracking-wider bg-indigo-50 px-2 py-1 rounded-md"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>Calculadora</button><span class="text-slate-400 text-xs font-bold">Quest√£o ${idx + 1} de ${questions.length}</span></div>
                    </div>
                    <h3 class="text-lg text-slate-800 font-medium leading-relaxed">${q.text}</h3>
                    <div class="grid grid-cols-1 gap-3">${q.options.map((opt, i) => `<button onclick="checkCfcAnswer(${i})" class="text-left p-4 rounded-2xl border border-slate-100 hover:border-indigo-300 hover:bg-indigo-50 transition-all text-sm text-slate-600 flex gap-4"><span class="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-[10px] font-bold text-slate-500 uppercase">${String.fromCharCode(65 + i)}</span>${opt}</button>`).join('')}</div>
                </div>`;
            window.startCfcTimer();
        }

        window.checkCfcAnswer = async (choice) => {
            const idx = globalState.userProgress.cfc_idx;
            const q = globalState.cfcQuestions[idx];
            if (choice === q.answer) {
                alert("Correto! üéâ" + (q.feedback ? `\n\n${q.feedback}` : ''));
                const nextIdx = idx + 1;
                await updateDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'appdata', 'state'), { cfc_idx: nextIdx });
            } else { alert("Incorreto. Tente de novo!"); }
        };

        window.resetCfc = async () => { await updateDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'appdata', 'state'), { cfc_idx: 0 }); };

        window.addEntryRow = () => {
            const cont = document.getElementById('entries-container');
            const row = document.createElement('div');
            row.className = 'flex gap-2 items-center bg-slate-50 p-2 rounded-xl border border-slate-100 mb-2';
            const accOpts = Object.keys(globalState.accounts).sort().map(a => `<option value="${a}">${a}</option>`).join('');
            row.innerHTML = `<select class="type-sel w-16 p-2 rounded-lg border-0 shadow-sm font-bold text-xs"><option value="D">D</option><option value="C">C</option></select><select class="acc-sel flex-1 p-2 rounded-lg border-0 shadow-sm text-xs"><option value="" disabled selected>Conta...</option>${accOpts}</select><input type="number" class="val-input w-28 p-2 rounded-lg border-0 shadow-sm text-right text-xs" placeholder="0,00"><button onclick="this.parentElement.remove(); updateSums();" class="text-slate-300 hover:text-red-500 px-2">√ó</button>`;
            cont.appendChild(row);
            row.querySelectorAll('select, input').forEach(el => el.addEventListener('input', window.updateSums));
        };

        window.updateSums = () => {
            let d = 0, c = 0;
            document.querySelectorAll('#entries-container > div').forEach(row => {
                const v = parseFloat(row.querySelector('.val-input').value) || 0;
                if(row.querySelector('.type-sel').value === 'D') d += v; else c += v;
            });
            document.getElementById('total-debit').innerText = fmt(d);
            document.getElementById('total-credit').innerText = fmt(c);
            return { d, c };
        };

        window.validateEntry = async () => {
            const sums = window.updateSums();
            if(sums.d === 0 || Math.abs(sums.d - sums.c) > 0.1) return alert("Partidas dobradas desequilibradas.");
            const q = globalState.simQuestions[globalState.userProgress.q_idx];
            if(!q) return;
            const entries = Array.from(document.querySelectorAll('#entries-container > div')).map(row => ({
                account: row.querySelector('.acc-sel').value, type: row.querySelector('.type-sel').value, val: parseFloat(row.querySelector('.val-input').value) || 0
            }));
            const isCorrect = q.answer.every(ans => entries.some(e => e.account === ans.account && e.type === ans.type && Math.abs(e.val - ans.val) < 1));
            if(isCorrect) {
                const newRazas = JSON.parse(JSON.stringify(globalState.userProgress.razas));
                entries.forEach(e => {
                    if(!newRazas[e.account]) newRazas[e.account] = [];
                    newRazas[e.account].push({ type: e.type, val: e.val });
                });
                const nextIdx = globalState.userProgress.q_idx + 1;
                document.getElementById('success-overlay').classList.remove('hidden');
                await updateDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'appdata', 'state'), { razas: newRazas, q_idx: nextIdx });
                setTimeout(() => {
                    document.getElementById('success-overlay').classList.add('hidden');
                    document.getElementById('entries-container').innerHTML = '';
                    renderSimulador();
                }, 1500);
            } else alert("Lan√ßamento incorreto.");
        };

        function renderSimulador() {
            if(globalState.view !== 'simulador') return;
            const q = globalState.simQuestions[globalState.userProgress.q_idx];
            if(!q) {
                document.getElementById('current-question-title').innerText = "Simulador Finalizado";
                return;
            }
            document.getElementById('current-question-title').innerText = q.title;
            document.getElementById('current-question-desc').innerText = q.desc;
            document.getElementById('difficulty-badge').innerText = q.level;
            document.getElementById('question-number-tag').innerText = `Quest√£o ${globalState.userProgress.q_idx + 1}`;
            renderAccountingInterface();
            if(document.getElementById('entries-container').children.length === 0) { window.addEntryRow(); window.addEntryRow(); }
        }

        function renderAccountingInterface() {
            const cont = document.getElementById('razonetes-container'); cont.innerHTML = '';
            let saldos = {}; let res = { rec: 0, des: 0 };
            Object.entries(globalState.userProgress.razas).forEach(([acc, movs]) => {
                let d = 0, c = 0; movs.forEach(m => m.type === 'D' ? d += m.val : c += m.val);
                const cfg = globalState.accounts[acc]; if(!cfg) return;
                let s = (cfg.group === 'Ativo' || cfg.group === 'Despesa') ? (d - c) : (c - d);
                saldos[acc] = s;
                if(cfg.group === 'Receita') res.rec += s; if(cfg.group === 'Despesa') res.des += s;
                const t = document.createElement('div'); t.className = 'bg-white p-2 border rounded-lg text-[8px] shadow-sm';
                t.innerHTML = `<div class="text-center font-bold border-b mb-1 uppercase">${acc}</div><div class="t-account grid grid-cols-2 min-h-[30px]"><div class="pr-1 text-blue-600">${movs.filter(m=>m.type==='D').map(m=>`<div>${m.val}</div>`).join('')}</div><div class="pl-1 text-red-600 text-right">${movs.filter(m=>m.type==='C').map(m=>`<div>${m.val}</div>`).join('')}</div></div><div class="text-right font-bold mt-1 border-t text-[7px]">${s.toLocaleString()}</div>`;
                cont.appendChild(t);
            });
            const grps = { Ativo: 0, Passivo: 0, PL: 0 }; const grpLists = { Ativo: '', Passivo: '', PL: '' };
            Object.entries(saldos).forEach(([acc, val]) => {
                const g = globalState.accounts[acc].group;
                if(grps[g] !== undefined) { grps[g] += val; grpLists[g] += `<div class="flex justify-between"><span>${acc}</span><span>${fmt(val)}</span></div>`; }
            });
            const lucro = res.rec - res.des; grps.PL += lucro;
            if(lucro !== 0) grpLists.PL += `<div class="flex justify-between font-bold italic"><span>L/P Exerc√≠cio</span><span>${fmt(lucro)}</span></div>`;
            document.getElementById('total-ativo').innerText = fmt(grps.Ativo); document.getElementById('total-passivo').innerText = fmt(grps.Passivo); document.getElementById('total-pl').innerText = fmt(grps.PL);
            document.getElementById('list-ativo').innerHTML = grpLists.Ativo; document.getElementById('list-passivo').innerHTML = grpLists.Passivo; document.getElementById('list-pl').innerHTML = grpLists.PL;
        }

        window.resetSimulador = async () => { if(confirm("Zerar progresso?")) await updateDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'appdata', 'state'), { razas: {}, q_idx: 0 }); };

        const initAuth = async () => { await signInAnonymously(auth); };
        initAuth();
    </script>
</body>
</html>