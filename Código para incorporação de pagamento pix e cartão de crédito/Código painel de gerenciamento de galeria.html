<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Administração</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCrAdXU968crHlyjzu5bMiDzv0wo16EHBs",
            authDomain: "arquitetura-e-interiores.firebaseapp.com",
            projectId: "arquitetura-e-interiores",
            storageBucket: "arquitetura-e-interiores.firebasestorage.app",
            messagingSenderId: "578518882376",
            appId: "1:578518882376:web:14d4064f4b8f6812fd607d",
            measurementId: "G-2FDB83L8TW"
        };
        
        // --- Firebase Initialization ---
        let db, auth, storage;
        let userId;
        const state = {
            photos: [],
            isEditing: false,
            editDocId: null
        };
        let uploadedImagesBase64 = [];
        let currentCarouselPhotos = [];
        let currentImageIndex = 0;

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        storage = getStorage(app);
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                showMainContent();
                setupListeners();
            } else {
                await signInAnonymously(auth);
            }
        });

        // --- UI Functions ---
        const showMainContent = () => {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('user-id').textContent = `ID do Usuário: ${userId}`;
        };

        const renderAdminPhotos = () => {
            const container = document.getElementById('admin-photos-container');
            container.innerHTML = '';
            state.photos.forEach(photo => {
                const photoCard = document.createElement('div');
                photoCard.classList.add('bg-white', 'rounded-lg', 'shadow-md', 'p-4', 'flex', 'flex-col', 'items-center', 'space-y-2');
                
                // Pega a primeira imagem para o preview, ou uma URL de placeholder se não houver imagens
                const previewImage = photo.images && photo.images.length > 0 ? photo.images[0].url : 'https://placehold.co/600x400/cccccc/333333?text=Sem+Imagem';
                
                photoCard.innerHTML = `
                    <div class="w-full h-32 bg-gray-200 rounded-md overflow-hidden">
                        <img src="${previewImage}" alt="${photo.description}" class="w-full h-full object-cover">
                    </div>
                    <p class="font-bold text-lg text-gray-800">${photo.name}</p>
                    <p class="font-semibold text-gray-600">${photo.description}</p>
                    <p class="text-sm text-gray-600">Categoria: ${photo.category}</p>
                    <p class="text-xs text-gray-500">${photo.images ? photo.images.length : 0} Imagem(ns)</p>
                    <div class="flex space-x-2 mt-2">
                        <button onclick="window.showPortfolioImages('${photo.id}')" class="px-3 py-1 bg-green-500 text-white text-sm rounded-md hover:bg-green-600 transition-colors">Visualizar</button>
                        <button onclick="window.editPhoto('${photo.id}')" class="px-3 py-1 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600 transition-colors">Editar</button>
                        <button onclick="window.confirmDeletePhoto('${photo.id}')" class="px-3 py-1 bg-red-500 text-white text-sm rounded-md hover:bg-red-600 transition-colors">Excluir</button>
                    </div>
                `;
                container.appendChild(photoCard);
            });
        };

        // --- Action Functions ---
        const setupListeners = () => {
            if (!auth.currentUser) {
                console.error("Usuário não autenticado. Não é possível configurar o listener do Firestore.");
                return;
            }
            const q = query(collection(db, `artifacts/${firebaseConfig.projectId}/public/data/galleries`));
            onSnapshot(q, (querySnapshot) => {
                state.photos = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminPhotos();
            }, (error) => {
                console.error("Erro no listener de snapshot:", error);
                showMessage('Erro ao carregar fotos. Verifique as permissões.', 'error');
            });
        };

        const showMessage = (message, type = 'info') => {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.className = 'p-3 mb-4 rounded-md text-white transition-opacity duration-300';
            
            if (type === 'success') {
                messageBox.classList.add('bg-green-500');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-500');
            } else {
                messageBox.classList.add('bg-blue-500');
            }
            
            messageBox.classList.remove('opacity-0', 'hidden');
            setTimeout(() => {
                messageBox.classList.add('opacity-0');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, 3000);
        };

        window.submitForm = async (event) => {
            event.preventDefault();
            const form = event.target;
            const imageURLInput = form.imageURL.value;
            const name = form.name.value;
            const description = form.description.value;
            const category = form.category.value;
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = state.isEditing ? 'Salvando...' : 'Adicionando...';

            if (!auth.currentUser) {
                showMessage('Aguardando autenticação para salvar a foto.', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = state.isEditing ? 'Salvar Edição' : 'Adicionar Imagem';
                return;
            }

            if (uploadedImagesBase64.length === 0 && !imageURLInput) {
                showMessage('Por favor, adicione pelo menos uma imagem ou uma URL.', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = state.isEditing ? 'Salvar Edição' : 'Adicionar Imagem';
                return;
            }

            try {
                if (state.isEditing) {
                    // Lógica para edição de um item existente.
                    // Para simplificar, a edição não permite mudar as imagens.
                    const docRef = doc(db, `artifacts/${firebaseConfig.projectId}/public/data/galleries`, state.editDocId);
                    const photoData = { name, description, category };
                    await updateDoc(docRef, photoData);
                    showMessage('Foto atualizada com sucesso!', 'success');
                } else {
                    // Lógica para adicionar um novo item de portfólio.
                    // Isso irá criar um único documento no Firestore com um array de imagens.
                    const imageAssets = [];
                    const uploadPromises = uploadedImagesBase64.map(async (imageData, index) => {
                        const file = form.imageFile.files[index];
                        
                        // Atualizado para usar um caminho de Storage mais genérico.
                        const storageRef = ref(storage, `galleries/${Date.now()}-${file.name}`);
                        
                        await uploadString(storageRef, imageData, 'data_url');
                        const url = await getDownloadURL(storageRef);
                        const path = storageRef.fullPath;
                        imageAssets.push({ url, path });
                    });
                    
                    if (imageURLInput) {
                        imageAssets.push({ url: imageURLInput, path: null });
                    }
                    
                    await Promise.all(uploadPromises);
                    
                    const portfolioData = {
                        name,
                        description,
                        category,
                        images: imageAssets,
                        timestamp: Date.now()
                    };
                    
                    await addDoc(collection(db, `artifacts/${firebaseConfig.projectId}/public/data/galleries`), portfolioData);
                    showMessage('Item de portfólio adicionado com sucesso!', 'success');
                }

                form.reset();
                uploadedImagesBase64 = [];
                document.getElementById('image-preview-container').classList.add('hidden');
                document.getElementById('image-previews').innerHTML = '';
                state.isEditing = false;
                state.editDocId = null;
                document.getElementById('add-form-title').textContent = 'Adicionar Novo Item de Portfólio';
                submitBtn.textContent = 'Adicionar Item';
                submitBtn.disabled = false;
            } catch (e) {
                console.error("Erro ao processar a foto:", e);
                if (e.code === 'permission-denied' || e.code === 'storage/unauthorized') {
                     showMessage('Erro de permissão. Por favor, verifique as regras de segurança do seu Firebase Storage.', 'error');
                } else {
                    showMessage('Erro ao salvar a foto. Por favor, tente novamente.', 'error');
                }
                submitBtn.disabled = false;
                submitBtn.textContent = state.isEditing ? 'Salvar Edição' : 'Adicionar Imagem';
            }
        };

        window.editPhoto = (docId) => {
            const photoToEdit = state.photos.find(p => p.id === docId);
            if (photoToEdit) {
                const form = document.getElementById('photo-form');
                
                form.name.value = photoToEdit.name;
                form.description.value = photoToEdit.description;
                form.category.value = photoToEdit.category;

                // Para o modo de edição, apenas mostramos o preview da primeira imagem.
                // O upload de novas imagens não é suportado no modo de edição para simplificar.
                uploadedImagesBase64 = [];
                document.getElementById('image-previews').innerHTML = `<img src="${photoToEdit.images[0].url}" alt="Pré-visualização da imagem" class="mt-2 rounded-md shadow-lg object-contain w-full h-48 sm:h-64">`;
                document.getElementById('image-preview-container').classList.remove('hidden');
                
                state.isEditing = true;
                state.editDocId = docId;
                document.getElementById('add-form-title').textContent = 'Editar Item de Portfólio';
                document.getElementById('submit-btn').textContent = 'Salvar Edição';
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };
        
        window.confirmDeletePhoto = (docId) => {
            const modal = document.getElementById('delete-modal');
            const confirmBtn = document.getElementById('confirm-delete-btn');
            
            confirmBtn.onclick = async () => {
                await window.deletePhoto(docId);
                modal.classList.add('hidden');
            };
            
            modal.classList.remove('hidden');
        };

        window.closeModal = () => {
            document.getElementById('delete-modal').classList.add('hidden');
        };

        window.deletePhoto = async (docId) => {
            if (!auth.currentUser) {
                showMessage('Aguardando autenticação para excluir a foto.', 'error');
                return;
            }
            
            const photoToDelete = state.photos.find(p => p.id === docId);
            if (!photoToDelete) {
                showMessage('Foto não encontrada.', 'error');
                return;
            }
            try {
                if (photoToDelete.images) {
                    // Exclui todas as imagens associadas a este item de portfólio
                    const deletePromises = photoToDelete.images.map(img => {
                        if (img.path) {
                            console.log('Tentando excluir arquivo em:', img.path);
                            return deleteObject(ref(storage, img.path));
                        }
                        return Promise.resolve();
                    });
                    await Promise.all(deletePromises);
                    console.log('Todos os arquivos do Storage excluídos com sucesso.');
                }
                
                await deleteDoc(doc(db, `artifacts/${firebaseConfig.projectId}/public/data/galleries`, docId));
                showMessage('Item de portfólio excluído com sucesso!', 'success');
            } catch (e) {
                console.error("Erro ao excluir a foto:", e);
                if (e.code === 'permission-denied' || e.code === 'storage/unauthorized') {
                     showMessage('Erro de permissão. Por favor, verifique as regras de segurança do seu Firebase Storage.', 'error');
                } else {
                    showMessage('Erro ao excluir a foto. Por favor, tente novamente.', 'error');
                }
            }
        };

        window.handleFileUpload = (event) => {
            const files = event.target.files;
            uploadedImagesBase64 = [];
            const previewsContainer = document.getElementById('image-previews');
            previewsContainer.innerHTML = '';
            
            if (files.length > 0) {
                document.getElementById('image-preview-container').classList.remove('hidden');
                for (let i = 0; i < files.length; i++) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadedImagesBase64.push(e.target.result);
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = `Pré-visualização da imagem ${i + 1}`;
                        img.classList.add('w-1/2', 'sm:w-1/4', 'h-auto', 'object-contain', 'rounded-md', 'shadow-lg');
                        previewsContainer.appendChild(img);
                    };
                    reader.readAsDataURL(files[i]);
                }
                document.getElementById('imageURL').value = '';
            } else {
                document.getElementById('image-preview-container').classList.add('hidden');
            }
        };

        /**
         * Exibe o modal com todas as imagens de um item de portfólio.
         * @param {string} docId - O ID do documento do Firestore.
         */
        window.showPortfolioImages = (docId) => {
            const portfolioItem = state.photos.find(p => p.id === docId);
            if (!portfolioItem || !portfolioItem.images || portfolioItem.images.length === 0) {
                showMessage('Nenhuma imagem encontrada para este projeto.', 'info');
                return;
            }

            currentCarouselPhotos = portfolioItem.images;
            currentImageIndex = 0;

            const viewerTitle = document.getElementById('viewer-title');
            const thumbnailsContainer = document.getElementById('carousel-thumbnails');

            viewerTitle.textContent = portfolioItem.name;
            thumbnailsContainer.innerHTML = '';

            currentCarouselPhotos.forEach((image, index) => {
                const thumbElement = document.createElement('img');
                thumbElement.src = image.url;
                thumbElement.alt = `Thumbnail ${index + 1}`;
                thumbElement.classList.add('w-20', 'h-20', 'object-cover', 'rounded-md', 'cursor-pointer', 'transition-all', 'duration-300', 'border-2', 'border-transparent', 'hover:border-indigo-500');
                thumbElement.onclick = () => window.jumpToImage(index);
                thumbnailsContainer.appendChild(thumbElement);
            });

            window.updateCarousel();
            document.getElementById('image-viewer-modal').classList.remove('hidden');
        };

        /**
         * Atualiza a imagem principal e a miniatura ativa no carrossel.
         */
        window.updateCarousel = () => {
            const mainImage = document.getElementById('main-carousel-image');
            const thumbnails = document.getElementById('carousel-thumbnails').children;

            if (currentCarouselPhotos.length > 0) {
                mainImage.src = currentCarouselPhotos[currentImageIndex].url;
                mainImage.alt = `Imagem ${currentImageIndex + 1} de ${currentCarouselPhotos.length}`;

                // Atualiza a borda da miniatura ativa
                for (let i = 0; i < thumbnails.length; i++) {
                    thumbnails[i].classList.remove('border-indigo-500');
                    if (i === currentImageIndex) {
                        thumbnails[i].classList.add('border-indigo-500');
                    }
                }
            }
        };

        /**
         * Navega para a imagem anterior no carrossel.
         */
        window.prevImage = () => {
            if (currentCarouselPhotos.length > 0) {
                currentImageIndex = (currentImageIndex - 1 + currentCarouselPhotos.length) % currentCarouselPhotos.length;
                window.updateCarousel();
            }
        };

        /**
         * Navega para a próxima imagem no carrossel.
         */
        window.nextImage = () => {
            if (currentCarouselPhotos.length > 0) {
                currentImageIndex = (currentImageIndex + 1) % currentCarouselPhotos.length;
                window.updateCarousel();
            }
        };

        /**
         * Pula para uma imagem específica no carrossel.
         * @param {number} index - O índice da imagem a ser exibida.
         */
        window.jumpToImage = (index) => {
            if (index >= 0 && index < currentCarouselPhotos.length) {
                currentImageIndex = index;
                window.updateCarousel();
            }
        };

        /**
         * Fecha o modal de visualização de imagens.
         */
        window.closeImageViewerModal = () => {
            document.getElementById('image-viewer-modal').classList.add('hidden');
        };

        window.onload = () => {};
    </script>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <!-- Loading Screen -->
    <div id="loading" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500 mx-auto"></div>
            <p class="mt-4 text-gray-600">Carregando...</p>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div id="app-container" class="container mx-auto p-4 md:p-8 space-y-12 hidden">
        
        <!-- Header -->
        <header class="text-center space-y-2">
            <h1 class="text-4xl font-extrabold text-indigo-800">Gerenciador de Galeria</h1>
            <p class="text-lg text-gray-600">Painel de Administração</p>
            <div id="message-box" class="opacity-0 hidden"></div>
        </header>
        
        <!-- User ID Display -->
        <div class="text-sm text-center text-gray-500 p-2 bg-white rounded-lg shadow-sm">
            <span id="user-id"></span>
        </div>
        
        <!-- Painel de Administração -->
        <section class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
            <h2 class="text-3xl font-bold text-center text-indigo-700 mb-6">Painel de Administração</h2>
            
            <!-- Formulário de Adição/Edição -->
            <form id="photo-form" onsubmit="window.submitForm(event)" class="space-y-4">
                <h3 id="add-form-title" class="text-xl font-semibold text-center text-gray-700 mb-4">Adicionar Novo Item de Portfólio</h3>
                
                <!-- Campos de Upload e URL -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Adicionar Imagem(ns)</label>
                    <div class="mt-1 flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                        <div class="w-full sm:w-1/2">
                            <label for="imageFile" class="block text-sm font-medium text-gray-700">Upload do Computador</label>
                            <input type="file" id="imageFile" name="imageFile" accept="image/*" multiple onchange="window.handleFileUpload(event)" class="mt-1 block w-full text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                        </div>
                        <div class="w-full sm:w-1/2">
                            <label for="imageURL" class="block text-sm font-medium text-gray-700">... ou URL da Imagem (apenas uma)</label>
                            <input type="url" id="imageURL" name="imageURL" placeholder="https://exemplo.com/sua-imagem.jpg" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"/>
                        </div>
                    </div>
                </div>
                
                <!-- Pré-visualização da Imagem -->
                <div class="hidden" id="image-preview-container">
                    <p class="text-sm font-medium text-gray-700 mb-2">Pré-visualizações:</p>
                    <div id="image-previews" class="flex flex-wrap gap-4 mt-2"></div>
                </div>
                
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Nome</label>
                    <input type="text" id="name" name="name" required placeholder="Ex: Projeto Residencial" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Descrição</label>
                    <input type="text" id="description" name="description" required placeholder="Uma breve descrição da imagem" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700">Categoria</label>
                    <select id="category" name="category" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="Projetos Interiores">Projetos Interiores</option>
                        <option value="Projetos Arquitetônicos">Projetos Arquitetônicos</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                
                <button id="submit-btn" type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                    Adicionar Imagem
                </button>
            </form>
            
            <hr class="my-8 border-t border-gray-200">
            
            <!-- Lista de Imagens Administráveis -->
            <h3 class="text-xl font-semibold text-center text-gray-700 mb-4">Meus Itens de Portfólio</h3>
            <div id="admin-photos-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Fotos serão renderizadas aqui -->
            </div>
        </section>
        
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div id="delete-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-sm text-center">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Confirmar Exclusão</h3>
            <p class="text-gray-600 mb-6">Tem certeza de que deseja excluir este item? Isso irá excluir todas as imagens associadas. Esta ação é irreversível.</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">Excluir</button>
                <button onclick="window.closeModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Visualização de Imagens -->
    <div id="image-viewer-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden relative flex flex-col">
            <button onclick="window.closeImageViewerModal()" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h3 id="viewer-title" class="text-lg font-bold text-gray-800 mb-4 text-center"></h3>
            
            <!-- Carrossel de Imagens -->
            <div class="flex flex-col items-center flex-grow">
                <!-- Imagem Principal e Botões de Navegação -->
                <div class="relative w-full h-96 flex items-center justify-center mb-4">
                    <button onclick="window.prevImage()" class="absolute left-2 z-10 p-2 rounded-full bg-gray-800 bg-opacity-50 text-white hover:bg-opacity-75 focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <img id="main-carousel-image" src="" alt="Imagem Principal" class="max-w-full max-h-full object-contain rounded-lg shadow-md">
                    <button onclick="window.nextImage()" class="absolute right-2 z-10 p-2 rounded-full bg-gray-800 bg-opacity-50 text-white hover:bg-opacity-75 focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
                
                <!-- Miniaturas (Thumbnails) para navegação -->
                <div id="carousel-thumbnails" class="flex-shrink-0 flex justify-center items-center overflow-x-auto w-full p-2 space-x-2">
                    <!-- Miniaturas serão injetadas aqui -->
                </div>
            </div>
        </div>
    </div>

</body>
</html>
