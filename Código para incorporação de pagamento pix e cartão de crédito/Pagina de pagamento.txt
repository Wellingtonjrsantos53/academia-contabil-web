<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout Transparente - Mercado Pago</title>
    <!-- Inclui o Tailwind CSS para estilização moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Container Principal do Checkout -->
    <div class="bg-white p-8 md:p-12 rounded-2xl shadow-2xl max-w-lg w-full">

        <!-- Título -->
        <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">Checkout</h2>
        <p class="text-gray-500 mb-8 text-center">Pagamento seguro com Mercado Pago.</p>

        <!-- Seletor de Método de Pagamento (Tabs) -->
        <div class="flex border-b border-gray-200 mb-6">
            <button id="tab-cartao" class="flex-1 py-3 px-4 font-semibold text-sm rounded-t-lg transition-colors duration-200 focus:outline-none border-b-2 border-blue-600 text-blue-600">
                Cartão de Crédito
            </button>
            <button id="tab-pix" class="flex-1 py-3 px-4 font-semibold text-sm rounded-t-lg transition-colors duration-200 focus:outline-none border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                Pix
            </button>
        </div>

        <!-- Seção do Formulário de Cartão de Crédito -->
        <div id="payment-card" class="payment-section">
            <form id="form-checkout">
                <div class="space-y-4">
                    <!-- Nome do Titular -->
                    <div>
                        <label for="form-checkout__cardholderName" class="block text-sm font-medium text-gray-700">Nome do Titular</label>
                        <input type="text" id="form-checkout__cardholderName" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200" placeholder="Nome impresso no cartão" required>
                    </div>

                    <!-- Email do Titular -->
                    <div>
                        <label for="form-checkout__cardholderEmail" class="block text-sm font-medium text-gray-700">E-mail</label>
                        <input type="email" id="form-checkout__cardholderEmail" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200" placeholder="seu-email@exemplo.com" required>
                    </div>

                    <!-- Número do Cartão -->
                    <div>
                        <label for="form-checkout__cardNumber" class="block text-sm font-medium text-gray-700">Número do Cartão</label>
                        <input type="text" id="form-checkout__cardNumber" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200" placeholder="XXXX XXXX XXXX XXXX" required>
                    </div>

                    <!-- Validade e CVC -->
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label for="form-checkout__cardExpirationDate" class="block text-sm font-medium text-gray-700">Validade</label>
                            <input type="text" id="form-checkout__cardExpirationDate" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200" placeholder="MM/AA" required>
                        </div>
                        <div class="flex-1">
                            <label for="form-checkout__securityCode" class="block text-sm font-medium text-gray-700">CVC</label>
                            <input type="text" id="form-checkout__securityCode" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200" placeholder="XXX" required>
                        </div>
                    </div>

                    <!-- Parcelas -->
                    <div>
                        <label for="form-checkout__installments" class="block text-sm font-medium text-gray-700">Parcelas</label>
                        <select id="form-checkout__installments" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200" required></select>
                    </div>

                    <!-- Tipo do Documento -->
                    <div>
                        <label for="form-checkout__identificationType" class="block text-sm font-medium text-gray-700">Tipo de Documento</label>
                        <select id="form-checkout__identificationType" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200" required></select>
                    </div>

                    <!-- Número do Documento -->
                    <div>
                        <label for="form-checkout__identificationNumber" class="block text-sm font-medium text-gray-700">Número do Documento</label>
                        <input type="text" id="form-checkout__identificationNumber" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200" placeholder="CPF ou CNPJ" required>
                    </div>
                </div>

                <div class="mt-6">
                    <button type="submit" id="form-checkout__submit" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-200 transform hover:scale-105">Pagar</button>
                </div>
            </form>
        </div>

        <!-- Seção do Pix -->
        <div id="payment-pix" class="payment-section hidden">
            <p class="text-center text-gray-600 mb-6">Escaneie o QR Code ou copie a chave Pix para realizar o pagamento.</p>
            <div id="pix-container" class="space-y-6">
                <!-- QR Code e Chave Pix serão gerados aqui -->
            </div>
            <button id="generate-pix-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-200 transform hover:scale-105">
                Gerar Pagamento Pix
            </button>
        </div>

        <!-- Feedback para o usuário -->
        <div id="feedback" class="mt-6 hidden">
            <div id="feedback-message" class="bg-gray-100 p-4 rounded-lg text-sm text-gray-700 text-center"></div>
        </div>

    </div>

    <!-- SDK do Mercado Pago -->
    <script src="https://sdk.mercadopago.com/js/v2"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Credenciais e Configuração ---
            // ATENÇÃO: Em produção, a chave privada (Access Token) JAMAIS deve ser exposta no frontend.
            // A chamada para a API de pagamentos deve ser feita a partir de um backend seguro.
            const PUBLIC_KEY = 'TEST-ea49e7f5-e1bb-414a-bbcf-1c1b1a73ea0a';
            const ACCESS_TOKEN = 'TEST-8155657262249649-091319-a2647f3eeb5a3e68df32ae7aeac4ce0e-290268833';
            const PRODUCT_AMOUNT = 100.00; // Valor total da compra
            const API_URL = 'https://api.mercadopago.com';

            const mp = new MercadoPago(PUBLIC_KEY, {
                locale: 'pt-BR'
            });

            // --- Variáveis DOM ---
            const tabCartao = document.getElementById('tab-cartao');
            const tabPix = document.getElementById('tab-pix');
            const paymentCardSection = document.getElementById('payment-card');
            const paymentPixSection = document.getElementById('payment-pix');
            const feedbackElement = document.getElementById('feedback');
            const feedbackMessage = document.getElementById('feedback-message');
            const formCheckout = document.getElementById('form-checkout');
            const generatePixBtn = document.getElementById('generate-pix-btn');
            const pixContainer = document.getElementById('pix-container');

            // --- Lógica de Navegação entre Abas ---
            function showSection(section) {
                paymentCardSection.classList.add('hidden');
                paymentPixSection.classList.add('hidden');
                feedbackElement.classList.add('hidden');
                
                if (section === 'card') {
                    paymentCardSection.classList.remove('hidden');
                    tabCartao.classList.add('border-blue-600', 'text-blue-600');
                    tabCartao.classList.remove('border-transparent', 'text-gray-500');
                    tabPix.classList.add('border-transparent', 'text-gray-500');
                    tabPix.classList.remove('border-blue-600', 'text-blue-600');
                } else if (section === 'pix') {
                    paymentPixSection.classList.remove('hidden');
                    tabPix.classList.add('border-blue-600', 'text-blue-600');
                    tabPix.classList.remove('border-transparent', 'text-gray-500');
                    tabCartao.classList.add('border-transparent', 'text-gray-500');
                    tabCartao.classList.remove('border-blue-600', 'text-blue-600');
                }
            }

            tabCartao.addEventListener('click', () => showSection('card'));
            tabPix.addEventListener('click', () => showSection('pix'));

            // --- Funções Auxiliares de Feedback ---
            function showFeedback(message, isError = false) {
                feedbackMessage.textContent = message;
                feedbackElement.classList.remove('hidden');
                if (isError) {
                    feedbackElement.classList.remove('bg-gray-100');
                    feedbackElement.classList.add('bg-red-100', 'text-red-700');
                } else {
                    feedbackElement.classList.remove('bg-red-100', 'text-red-700');
                    feedbackElement.classList.add('bg-gray-100');
                }
            }
            
            function showLoading(show) {
                const submitBtn = document.getElementById('form-checkout__submit');
                const pixBtn = document.getElementById('generate-pix-btn');
                
                if (show) {
                    if (submitBtn) {
                        submitBtn.textContent = 'Processando...';
                        submitBtn.disabled = true;
                    }
                    if (pixBtn) {
                        pixBtn.textContent = 'Gerando...';
                        pixBtn.disabled = true;
                    }
                } else {
                    if (submitBtn) {
                        submitBtn.textContent = 'Pagar';
                        submitBtn.disabled = false;
                    }
                    if (pixBtn) {
                        pixBtn.textContent = 'Gerar Pagamento Pix';
                        pixBtn.disabled = false;
                    }
                }
            }


            // --- Lógica de Pagamento com Cartão de Crédito (CardForm) ---
            try {
                const cardForm = mp.cardForm({
                    amount: PRODUCT_AMOUNT.toString(),
                    form: {
                        id: "form-checkout",
                        cardNumber: { id: "form-checkout__cardNumber", placeholder: "Número do Cartão" },
                        cardholderName: { id: "form-checkout__cardholderName", placeholder: "Nome do Titular" },
                        cardExpirationDate: { id: "form-checkout__cardExpirationDate", placeholder: "MM/AA" },
                        securityCode: { id: "form-checkout__securityCode", placeholder: "CVC" },
                        installments: { id: "form-checkout__installments", placeholder: "Parcelas" },
                        identificationType: { id: "form-checkout__identificationType", placeholder: "Tipo de Documento" },
                        identificationNumber: { id: "form-checkout__identificationNumber", placeholder: "Número do Documento" },
                        cardholderEmail: { id: "form-checkout__cardholderEmail", placeholder: "E-mail" }
                    },
                    callbacks: {
                        onFormMounted: error => {
                            if (error) return console.warn("Form Mounted handling error: ", error);
                            console.log("Formulário de cartão montado.");
                        },
                        onSubmit: event => {
                            event.preventDefault();
                            showLoading(true);

                            const formData = cardForm.getFormData();
                            
                            // Verifica se o issuer foi identificado
                            if (!formData.issuerId) {
                                showFeedback("Não foi possível identificar a bandeira do cartão. Verifique o número e tente novamente.", true);
                                showLoading(false);
                                return;
                            }

                            const {
                                paymentMethodId: payment_method_id,
                                issuerId: issuer_id,
                                cardholderEmail: email,
                                amount,
                                installments,
                                identificationNumber,
                                identificationType,
                                cardId,
                                cardholderName,
                                securityCode,
                                token
                            } = formData;
                            
                            // Objeto de pagamento para a API
                            const paymentData = {
                                transaction_amount: Number(amount),
                                token,
                                description: "Produto do E-commerce",
                                installments: Number(installments),
                                payment_method_id,
                                issuer_id,
                                payer: {
                                    email,
                                    identification: {
                                        type: identificationType,
                                        number: identificationNumber,
                                    },
                                },
                            };

                            // A chamada para a API de pagamentos deve ser feita no backend
                            // para evitar expor o Access Token.
                            // O código abaixo é apenas um exemplo de como seria a chamada.
                            fetch(`${API_URL}/v1/payments`, {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "Authorization": `Bearer ${ACCESS_TOKEN}`
                                },
                                body: JSON.stringify(paymentData)
                            })
                            .then(response => response.json())
                            .then(data => {
                                showLoading(false);
                                if (data.status === 'approved') {
                                    showFeedback("Pagamento aprovado! Obrigado pela sua compra.", false);
                                    console.log('Pagamento Aprovado:', data);
                                    formCheckout.reset();
                                } else {
                                    showFeedback(`Pagamento recusado. Status: ${data.status_detail}`, true);
                                    console.error('Pagamento Recusado:', data);
                                }
                            })
                            .catch(error => {
                                showLoading(false);
                                showFeedback("Ocorreu um erro no processamento do pagamento. Tente novamente.", true);
                                console.error('Erro no processamento:', error);
                            });
                        },
                        onFetching: (resource) => {
                            console.log("Fetching resource: ", resource);
                        }
                    },
                });
            } catch (error) {
                console.error("Erro ao inicializar o CardForm:", error);
                showFeedback("Erro ao carregar o formulário de cartão. Tente recarregar a página.", true);
            }

            // --- Lógica de Pagamento com Pix ---
            generatePixBtn.addEventListener('click', async () => {
                showLoading(true);
                pixContainer.innerHTML = '';
                
                // Objeto de pagamento para a API do Pix
                const pixPaymentData = {
                    transaction_amount: PRODUCT_AMOUNT,
                    description: "Produto do E-commerce",
                    payment_method_id: "pix",
                    payer: {
                        email: "test@test.com", // Substituir pelo email real do cliente
                        first_name: "Test",
                        last_name: "User",
                        identification: {
                            type: "CPF",
                            number: "12345678909" // Substituir pelo CPF real do cliente
                        }
                    }
                };
                
                try {
                    const response = await fetch(`${API_URL}/v1/payments`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${ACCESS_TOKEN}`
                        },
                        body: JSON.stringify(pixPaymentData)
                    });

                    const data = await response.json();
                    showLoading(false);

                    if (data.status === 'pending') {
                        // A API retorna o QR Code em base64 e a chave Pix
                        const qrBase64 = data.point_of_interaction.transaction_data.qr_code_base64;
                        const qrCode = data.point_of_interaction.transaction_data.qr_code;
                        
                        pixContainer.innerHTML = `
                            <div class="flex flex-col items-center">
                                <img src="data:image/jpeg;base64,${qrBase64}" alt="QR Code Pix" class="w-48 h-48 rounded-lg shadow-md mb-4">
                                <div class="w-full text-center">
                                    <p class="text-gray-600 mb-2 font-medium">Chave Pix (Copia e Cola):</p>
                                    <div class="relative">
                                        <input type="text" id="pix-key-input" class="w-full text-center p-2 border border-dashed border-gray-400 rounded-lg text-sm text-gray-800" value="${qrCode}" readonly>
                                        <button id="copy-pix-btn" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 transition-colors duration-200" title="Copiar chave Pix">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" /><path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h8a2 2 0 00-2-2H5z" /></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Adiciona o listener para o botão de copiar
                        document.getElementById('copy-pix-btn').addEventListener('click', () => {
                            const pixInput = document.getElementById('pix-key-input');
                            pixInput.select();
                            document.execCommand('copy');
                            showFeedback("Chave Pix copiada para a área de transferência!", false);
                        });
                        
                        showFeedback("Pagamento Pix gerado com sucesso! Verifique a área abaixo.", false);
                    } else {
                        showFeedback(`Erro ao gerar Pix. Status: ${data.status_detail}`, true);
                        console.error('Erro ao gerar Pix:', data);
                    }

                } catch (error) {
                    showLoading(false);
                    showFeedback("Ocorreu um erro no processamento do Pix. Tente novamente.", true);
                    console.error('Erro no processamento do Pix:', error);
                }
            });

            // Mostra a seção de cartão por padrão
            showSection('card');
        });
    </script>
</body>
</html>
